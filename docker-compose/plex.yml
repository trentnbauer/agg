version: '2.3'
services:
  app:
    image: ghcr.io/linuxserver/plex:1.40.2@sha256:55c6c1bbc40936f527dc684946c2c32fdc2f0669467c1f359a70ea911593ea6e
    network_mode: host ###Leave this as it may detect your LAN traffic as WAN, forcing encoding. It may also run into issues if your internert is down
    ports:
      - ${PORT:-32400}:32400
      - 1900:1900/udp
      - 3005:3005
      - 5353:5353/udp
      - 8324:8324
      - 32410:32410/udp
      - 32412:32412/udp
      - 32413:32413/udp
      - 32414:32414/udp
      - 32469:32469
    devices:
      - /dev/dri:/dev/dri
    environment:
      #- PUID=1000
      #- PGID=1000
      - VERSION=docker
      - PLEX_CLAIM=$PLEX_CLAIM
      - NVIDIA_VISIBLE_DEVICES=ALL
    runtime: nvidia
    volumes:
      - app:/config
      - media:/nfs/Media
      - /dev/shm:/dev/shm
    restart: unless-stopped
    healthcheck:
      test: curl --connect-timeout 15 --silent --show-error --fail http://localhost:32400/identity
      interval: 1m
      timeout: 30s
      retries: 3
      start_period: 1m
    labels:
      - "autoheal=true"
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "3"
  jellyfin:
    image: ghcr.io/linuxserver/jellyfin:version-10.9.2ubu2204
    network_mode: host
    environment:
      #- PUID=1000
      #- PGID=1000
      - TZ=$TZ
    volumes:
      - config:/config
      - media:/nfs/Media
      - /dev/shm:/dev/shm
    ports:
      - ${PORT:-8096}:8096
      - 8920:8920 #optional
      - 7359:7359/udp #optional
      #- 1900:1900/udp #optional
    #devices:
      #- /dev/dri:/dev/dri #optional
      #- /dev/vcsm:/dev/vcsm #optional
      #- /dev/vchiq:/dev/vchiq #optional
      #- /dev/video10:/dev/video10 #optional
      #- /dev/video11:/dev/video11 #optional
      #- /dev/video12:/dev/video12 #optional
    restart: unless-stopped    
    #healthcheck:
      #test: curl --connect-timeout 15 --silent --show-error --fail http://localhost:8096
      #interval: 1m
      #timeout: 30s
      #retries: 3
      #start_period: 1m
    #labels:
      #- "autoheal=true"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"
volumes:
  config:
  app:
  media:
    driver_opts:
      type: nfs 
      o: $STORAGE,nfsvers=4
      device: :$MEDIA
