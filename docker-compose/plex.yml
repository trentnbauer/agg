version: "2.1"
services:
  app:
    image: ghcr.io/linuxserver/plex:1.40.2@sha256:114bc1566b442144552843fe43c45ca1a4fb023b46ce2c75485d611792e45519
    network_mode: host
    ports:
      - $PORT:32400
      - 1900:1900/udp
      - 3005:3005
      - 5353:5353/udp
      - 8324:8324
      - 32410:32410/udp
      - 32412:32412/udp
      - 32413:32413/udp
      - 32414:32414/udp
      - 32469:32469
    #devices:
     # - /dev/dri:/dev/dri
    environment:
      #- PUID=1000
      #- PGID=1000
      - VERSION=docker
      - PLEX_CLAIM=$PLEX_CLAIM
      - NVIDIA_VISIBLE_DEVICES=ALL
    runtime: nvidia
    volumes:
      - app:/config
      #- $MEDIA:$MEDIA
      - media:/nfs/Media
      - /dev/shm:/dev/shm
    restart: unless-stopped
    healthcheck:
      test: curl --connect-timeout 15 --silent --show-error --fail http://localhost:$PORT/identity
      interval: 1m
      timeout: 30s
      retries: 3
      start-period: 1m

volumes:
  app:
  media:
    driver_opts:
      type: nfs 
      o: $STORAGE,nfsvers=4
      device: :$MEDIA
